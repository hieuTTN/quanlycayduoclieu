<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DuocLieuVN - Trang ch·ªß</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/main.js"></script>
    <script src="js/plant.js"></script>
    <script>
      window.onload = function(){
        loadPlantIndex()
      }
    </script>
</head>
<body>

<!-- Header -->
<header id="header-main">
  
</header>

<!-- Hero -->
<section class="bg-success bg-gradient text-white text-center py-5">
  <div class="container">
    <h1 class="display-4 fw-bold">C√¢y D∆∞·ª£c Li·ªáu Vi·ªát Nam</h1>
    <p class="lead mt-3">H·ªá th·ªëng qu·∫£n l√Ω th√¥ng tin c√¢y d∆∞·ª£c li·ªáu, b√†i vi·∫øt nghi√™n c·ª©u v√† chuy√™n gia</p>
    <div class="mt-4 d-flex justify-content-center gap-3">
      <a href="/plants" class="btn btn-lg btn-light text-success fw-semibold">Kh√°m ph√° c√¢y d∆∞·ª£c li·ªáu</a>
      <a href="/articles" class="btn btn-lg btn-outline-light">B√†i vi·∫øt nghi√™n c·ª©u</a>
    </div>
  </div>
</section>

<!-- Search -->
<section class="py-5 bg-white">
  <div class="container" style="max-width:600px;">
    <div class="input-group input-group-lg">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" placeholder="T√¨m ki·∫øm c√¢y d∆∞·ª£c li·ªáu...">
    </div>
  </div>
</section>

<!-- Categories -->
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="text-center fw-bold mb-5">Danh m·ª•c ch√≠nh</h2>
    <div class="row g-4">
      <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
          <img src="/image/cay-duoc-lieu.jpg" class="card-img-top p-3" alt="">
          <div class="card-body">
            <h5 class="card-title">C√¢y D∆∞·ª£c Li·ªáu</h5>
            <p class="card-text">Th√¥ng tin chi ti·∫øt v·ªÅ c√°c lo·∫°i c√¢y d∆∞·ª£c li·ªáu Vi·ªát Nam</p>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a href="/plants" class="btn btn-success w-100">Xem danh s√°ch</a>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
          <img src="/placeholder.svg?height=160&width=320" class="card-img-top p-3" alt="">
          <div class="card-body">
            <h5 class="card-title">B√†i Vi·∫øt</h5>
            <p class="card-text">C√°c b√†i vi·∫øt v·ªÅ c√¢y d∆∞·ª£c li·ªáu v√† c√¥ng d·ª•ng</p>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a href="/articles" class="btn btn-success w-100">Xem b√†i vi·∫øt</a>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
          <img src="/placeholder.svg?height=160&width=320" class="card-img-top p-3" alt="">
          <div class="card-body">
            <h5 class="card-title">Nghi√™n C·ª©u</h5>
            <p class="card-text">ƒê·ªÅ t√†i nghi√™n c·ª©u khoa h·ªçc v·ªÅ d∆∞·ª£c li·ªáu</p>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a href="/research" class="btn btn-success w-100">Xem nghi√™n c·ª©u</a>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
          <img src="/placeholder.svg?height=160&width=320" class="card-img-top p-3" alt="">
          <div class="card-body">
            <h5 class="card-title">Chuy√™n Gia</h5>
            <p class="card-text">Th√¥ng tin v·ªÅ c√°c chuy√™n gia d∆∞·ª£c li·ªáu</p>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a href="/experts" class="btn btn-success w-100">Xem chuy√™n gia</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Featured Plants -->
<section class="py-5 bg-white">
  <div class="container">
    <h2 class="text-center fw-bold mb-5">C√¢y d∆∞·ª£c li·ªáu n·ªïi b·∫≠t</h2>
    <div class="row g-4" id="listcaynoibat">
      <div class="col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <img src="/placeholder.svg?height=192&width=384&text=C√¢y+1" class="card-img-top" alt="">
          <div class="card-body">
            <h5 class="card-title">C√¢y d∆∞·ª£c li·ªáu 1</h5>
            <p class="card-text">M√¥ t·∫£ ng·∫Øn v·ªÅ c√¥ng d·ª•ng v√† ƒë·∫∑c t√≠nh</p>
            <p class="text-muted small">Th√¥ng tin chi ti·∫øt v·ªÅ c√¢y d∆∞·ª£c li·ªáu, ngu·ªìn g·ªëc, ph√¢n b·ªë v√† ƒë·∫∑c ƒëi·ªÉm nh·∫≠n d·∫°ng.</p>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a href="/plants/1" class="btn btn-outline-success w-100">Xem chi ti·∫øt</a>
          </div>
        </div>
      </div>
      <!-- th√™m c√°c c√¢y 2-6 t∆∞∆°ng t·ª± -->
    </div>
    <div class="mt-5 text-center">
      <a href="/plants" class="btn btn-outline-success btn-lg px-4">Xem t·∫•t c·∫£ c√¢y d∆∞·ª£c li·ªáu</a>
    </div>
  </div>
</section>


<!-- Footer -->
<footer class="pt-5" id="footer-main">
 
</footer>

<div class="chatbot-container">
    <div class="chatbox hidden" id="chatbox">
        <div class="chat-header">ü§ñ H·ªó tr·ª£ AI </div>
        
        <div class="chat-messages" id="chat-messages">
        </div>

        <div class="chat-suggestions">
            <button id="toggle-suggestions-btn">
                üí° G·ª£i √Ω c√¢u h·ªèi
            </button>
            <div class="suggestion-list hidden" id="suggestion-list">
            </div>
        </div>

        <div class="chat-input-wrapper" id="chat-input-container">
            <div class="drop-zone hidden" id="drop-zone">
                Th·∫£ ·∫£nh v√†o ƒë√¢y ƒë·ªÉ g·ª≠i
            </div>

            <div class="image-preview-area hidden" id="image-preview-area">
                <img id="preview-image" src="" alt="·∫¢nh ƒë√£ ch·ªçn" />
                <button id="remove-image-btn">‚úñ</button>
            </div>
            <div class="chat-input">
                <input type="file" id="image-file-input" accept="image/*" class="hidden">
                
                <button id="attach-btn" class="input-action-btn" title="G·ª≠i ·∫£nh">üìé</button>
                
                <input
                    type="text"
                    id="chat-input-text"
                    placeholder="Nh·∫≠p tin nh·∫Øn..."
                />
                
                <button id="send-message-btn" class="input-action-btn send-btn">G·ª≠i</button>
            </div>
            
        </div>
        
    </div>

    <button class="chat-toggle" id="chat-toggle-btn">
        üí¨ H·ªó tr·ª£ AI
    </button>
</div>
</body>
<script>
// --- Khai b√°o State v√† Data ---
let isOpen = false;
let messages = [];
let showSuggestions = false;
let selectedFile = null; // Bi·∫øn l∆∞u tr·ªØ file ·∫£nh ƒë√£ ch·ªçn/k√©o

const suggestions = [
    "C√¢y S√¢m Ng·ªçc Linh c√≥ c√¥ng d·ª•ng g√¨?",
    "Li·ªát k√™ c√°c c√¢y d∆∞·ª£c li·ªáu d√πng ƒë·ªÉ ch·ªØa b·ªánh ti·ªÉu ƒë∆∞·ªùng.",
    "T√¨nh tr·∫°ng c√¢y Qu·∫ø t·∫°i l√¥ S1-A hi·ªán t·∫°i l√† g√¨?",
    "Th·ªùi ƒëi·ªÉm thu ho·∫°ch t·ªët nh·∫•t c·ªßa c√¢y X·∫° ƒêen l√† khi n√†o?",
    "T√¨m quy tr√¨nh nh√¢n gi·ªëng cho c√¢y Ba K√≠ch.",
    "C√¢y n√†o c√≥ ho·∫°t ch·∫•t t∆∞∆°ng t·ª± c√¢y B·∫°ch Ch·ªâ?",
    "Nhi·ªát ƒë·ªô l√Ω t∆∞·ªüng ƒë·ªÉ tr·ªìng c√¢y Lan Kim Tuy·∫øn l√† bao nhi√™u?",
    "Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho c·ªßa d∆∞·ª£c li·ªáu ƒêinh LƒÉng.",
];

// --- Tham chi·∫øu DOM ---
const chatbox = document.getElementById('chatbox');
const chatToggleBtn = document.getElementById('chat-toggle-btn');
const messagesContainer = document.getElementById('chat-messages');
const inputText = document.getElementById('chat-input-text');
const sendBtn = document.getElementById('send-message-btn');
const toggleSuggestionsBtn = document.getElementById('toggle-suggestions-btn');
const suggestionList = document.getElementById('suggestion-list');
const attachBtn = document.getElementById('attach-btn');
const imageFileInput = document.getElementById('image-file-input');
const dropZone = document.getElementById('drop-zone');
const imagePreviewArea = document.getElementById('image-preview-area'); // M·ªõi
const previewImage = document.getElementById('preview-image'); // M·ªõi
const removeImageBtn = document.getElementById('remove-image-btn'); // M·ªõi


// H√†m m√¥ ph·ªèng API postMethodPayload
async function postMethodPayload(url, payload) {
    return new Promise(resolve => {
        setTimeout(() => {
            let reply = "ƒê√£ nh·∫≠n ƒë∆∞·ª£c y√™u c·∫ßu c·ªßa b·∫°n. Vui l√≤ng ch·ªù ph·∫£n h·ªìi chi ti·∫øt.";
            if (payload.hasImage) {
                reply = "C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i ·∫£nh! T√¥i s·∫Ω xem x√©t v√† ph·∫£n h·ªìi s·ªõm.";
            } else if (payload.message.includes('Menu') || payload.message.includes('m√≥n g√¨')) {
                reply = "Menu h√¥m nay c√≥ C√° h·ªìi √°p ch·∫£o v√† Salad Nga.";
            }
            resolve({
                json: () => Promise.resolve({ reply: reply })
            });
        }, 800);
    });
}

// H√†m hi·ªÉn th·ªã/x√≥a preview ·∫£nh
function updateImagePreview() {
    if (selectedFile) {
        // Hi·ªÉn th·ªã preview
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            imagePreviewArea.classList.remove('hidden');
        };
        reader.readAsDataURL(selectedFile);
        inputText.focus();
    } else {
        // X√≥a preview
        imagePreviewArea.classList.add('hidden');
        previewImage.src = '';
        inputText.placeholder = "Nh·∫≠p tin nh·∫Øn...";
    }
}

// X·ª≠ l√Ω khi nh·∫•n n√∫t x√≥a ·∫£nh
function removeImage() {
    selectedFile = null;
    imageFileInput.value = null; // ƒê·∫∑t l·∫°i input file
    updateImagePreview();
}

// H√†m render l·∫°i danh s√°ch tin nh·∫Øn (ƒê√£ c·∫£i ti·∫øn)
function renderMessages() {
    messagesContainer.innerHTML = '';
    messages.forEach((m, i) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${m.role}`;
        
        const contentSpan = document.createElement('span');
        contentSpan.innerHTML = `<b>${m.role === "user" ? "B·∫°n" : "Bot"}:</b> ${m.text || (m.role === 'user' && m.file ? ' [ƒê√£ g·ª≠i ·∫£nh]' : '')}`;
        messageDiv.appendChild(contentSpan);

        if (m.role === 'user' && m.file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'message-image-preview';
                messageDiv.appendChild(img);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
            reader.readAsDataURL(m.file);
        }

        messagesContainer.appendChild(messageDiv);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// H√†m render l·∫°i danh s√°ch g·ª£i √Ω (Gi·ªØ nguy√™n)
function renderSuggestions() {
    suggestionList.innerHTML = '';
    suggestions.forEach((s, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'suggestion-item';
        itemDiv.textContent = s;
        itemDiv.onclick = () => handleSuggestionClick(s);
        suggestionList.appendChild(itemDiv);
    });
}

// H√†m g·ª≠i tin nh·∫Øn (ƒê√£ c·∫£i ti·∫øn)
async function sendMessage() {
    const message = inputText.value.trim();
    
    if (!message && !selectedFile) return;

    // 1. C·∫≠p nh·∫≠t tin nh·∫Øn ng∆∞·ªùi d√πng
    const userMessage = {
        role: "user",
        text: message,
        file: selectedFile
    };
    messages = [...messages, userMessage];
    
    // X√≥a n·ªôi dung input v√† file
    inputText.value = "";
    removeImage(); // X√≥a preview v√† reset selectedFile
    
    showSuggestions = false; 
    suggestionList.classList.add('hidden');
    renderMessages();

    // 2. G·ªçi API
    const apiPayload = { 
        message: userMessage.text, 
        hasImage: !!userMessage.file 
    };
    
    try {
        const res = await postMethodPayload("/api/chat", apiPayload); 
        const data = await res.json();
        
        // 3. C·∫≠p nh·∫≠t tin nh·∫Øn bot
        messages = [...messages, { role: "bot", text: data.reply }];
        renderMessages();
    } catch (error) {
        messages = [...messages, { role: "bot", text: "L·ªói k·∫øt n·ªëi! Kh√¥ng th·ªÉ nh·∫≠n ph·∫£n h·ªìi." }];
        renderMessages();
    }
}

// H√†m x·ª≠ l√Ω khi click v√†o g·ª£i √Ω
function handleSuggestionClick(suggestion) {
    // Lu√¥n lu√¥n th√™m g·ª£i √Ω v√†o input text
    inputText.value += (inputText.value ? " " : "") + suggestion;
    inputText.focus();
}

// H√†m b·∫≠t/t·∫Øt chat v√† g·ª£i √Ω (Gi·ªØ nguy√™n)
function toggleChat() {
    isOpen = !isOpen;
    if (isOpen) {
        chatbox.classList.remove('hidden');
        chatToggleBtn.innerHTML = '‚úñ';
        showSuggestions = false;
        suggestionList.classList.add('hidden');
    } else {
        chatbox.classList.add('hidden');
        chatToggleBtn.innerHTML = 'üí¨ H·ªó tr·ª£ AI';
    }
}
function toggleSuggestions() {
    showSuggestions = !showSuggestions;
    suggestionList.classList.toggle('hidden', !showSuggestions);
}

// --- LOGIC X·ª¨ L√ù FILE V√Ä K√âO TH·∫¢ ---

// X·ª≠ l√Ω khi c√≥ file ·∫£nh ƒë∆∞·ª£c ch·ªçn/k√©o
function handleFile(file) {
    if (file.type.startsWith('image/')) {
        selectedFile = file;
        updateImagePreview();
    } else {
        alert("Ch·ªâ h·ªó tr·ª£ file ·∫£nh.");
        selectedFile = null;
    }
}

// 1. X·ª≠ l√Ω n√∫t ƒë√≠nh k√®m
attachBtn.addEventListener('click', () => {
    imageFileInput.click();
});

// 2. X·ª≠ l√Ω khi ch·ªçn file b·∫±ng input
imageFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
        e.target.value = null; 
    }
});

// 3. X·ª≠ l√Ω n√∫t x√≥a ·∫£nh preview
removeImageBtn.addEventListener('click', removeImage);

// 4. X·ª≠ l√Ω k√©o v√† th·∫£ (Drag and Drop)
chatbox.addEventListener('dragenter', (e) => {
    e.preventDefault();
    if (e.dataTransfer.types && e.dataTransfer.types.includes('Files')) {
         dropZone.classList.remove('hidden');
    }
});
chatbox.addEventListener('dragleave', (e) => {
    if (!chatbox.contains(e.relatedTarget)) {
        dropZone.classList.add('hidden');
    }
});
chatbox.addEventListener('dragover', (e) => {
    e.preventDefault(); 
    dropZone.classList.remove('hidden');
});
chatbox.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.add('hidden');
    
    if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
    }
});


// --- Thi·∫øt l·∫≠p Event Listeners khi DOM ƒë√£ t·∫£i xong ---
document.addEventListener('DOMContentLoaded', () => {
    // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
    chatbox.classList.add('hidden');
    suggestionList.classList.add('hidden');
    imagePreviewArea.classList.add('hidden'); // ·∫®n preview ban ƒë·∫ßu
    renderSuggestions();

    // G·∫Øn s·ª± ki·ªán
    chatToggleBtn.addEventListener('click', toggleChat);
    sendBtn.addEventListener('click', sendMessage);
    toggleSuggestionsBtn.addEventListener('click', toggleSuggestions);

    inputText.addEventListener('keydown', (e) => {
        if (e.key === "Enter") {
            sendMessage();
            e.preventDefault();
        }
    });
});
</script>
</html>
