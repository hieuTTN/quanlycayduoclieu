<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Thêm nghiên cứu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.2/js/toastr.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="/admin/css/styleadmin.css">
  <script src="/admin/js/main.js"></script>
  <script src="/admin/js/research.js"></script>
  <script>
    window.onload = async function() {
        await loadResearchStatus();
        await loadPlants();
        loadAResearch();
    }
  </script>
</head>
<body>
  <div class="d-flex">
    <div id="header-admin"></div>
    <div class="flex-grow-1 d-flex flex-column">
      <div id="navbar-admin"></div>
      <main class="main bg-light flex-grow-1">
        <div class="container py-4">
        <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between mb-4 px-3">
            <div>
                <h1 class="h4 fw-bold text-dark mb-1">Thêm nghiên cứu</h1>
                <p class="text-muted small mb-0">Nhập thông tin chi tiết về nghiên cứu cây dược liệu</p>
            </div>
            <div class="mt-3 mt-sm-0">
                <button onclick="saveReseach()" id="btnSave" class="btn btn-success d-flex align-items-center gap-1">
                <i data-lucide="save"></i>
                <span>Lưu</span>
                </button>
            </div>
        </div>
        <div id="articleForm">
            <div class="row g-4">
                <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                    <h5 class="mb-0">Nội dung nghiên cứu</h5>
                    </div>
                    <div class="card-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Tiêu đề</label>
                        <input onkeyup="createSlug(this.value)" type="text" class="form-control" id="title" placeholder="Nhập tiêu đề">
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Slug</label>
                        <input type="text" class="form-control" id="slug" placeholder="Nhập slug">
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Các tác giả</label>
                        <input type="text" class="form-control" id="authors" placeholder="Các tác giả">
                    </div>
                    <div class="mb-3">
                        <label for="abstractText" class="form-label">Tóm tắt</label>
                        <textarea class="form-control" id="abstractText" rows="3" placeholder="Nhập tóm tắt ngắn gọn..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Tổ chức</label>
                        <input type="text" class="form-control" id="institution" placeholder="Tổ chức">
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Tạp chí</label>
                        <input type="text" class="form-control" id="journal" placeholder="Được đăng lên tạp chí">
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <label for="title" class="form-label">Lĩnh vực</label>
                            <select class="form-select" id="field">
                                <option value="Dược lý">Dược lý</option>
                                <option value="Hóa dược">Hóa dược</option>
                                <option value="Thực vật học">Thực vật học</option>
                                <option value="Y học">Y học</option>
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label for="title" class="form-label">Năm xuất bản</label>
                            <select class="form-select" id="publishedYear">

                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">&ThinSpace;</label>
                        <textarea class="form-control" id="editor" placeholder="Nhập nội dung chi tiết..."></textarea>
                    </div>
                    </div>
                </div>
                </div>

                <!-- Sidebar phải -->
                <div class="col-lg-4">
                <!-- Ảnh bìa -->
                <div class="card mb-4">
                    <div class="card-header">
                    <h6 class="mb-0">Các cây dược liệu</h6>
                    </div>
                    <div class="card-body text-center">
                        <select class="form-control" id="plants" multiple>

                        </select>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                    <h6 class="mb-0">Ảnh bìa</h6>
                    </div>
                    <div class="card-body text-center">
                    <div id="previewWrapper" class="border bg-light rounded mb-3 p-3 d-flex align-items-center justify-content-center" style="aspect-ratio: 16/9;">
                        <span class="text-muted">Chưa có ảnh</span>
                    </div>
                    <input type="file" id="featuredImage" class="form-control mb-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" id="removeImage" disabled>
                        <i data-lucide="x"></i> Xóa ảnh
                    </button>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                    <h6 class="mb-0">Tài liệu</h6>
                    </div>
                    <div class="card-body text-center">
                        <input type="file" class="form-control" id="choose-doc">
                        <div class="alert alert-primary alert-dismissible fade show mt-3" role="alert">
                            <span id="noti-choosefile">Chưa có file nào được chọn</span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </div>
                </div>

                <!-- Trạng thái -->
                <div class="card">
                    <div class="card-header">
                    <h6 class="mb-0">Xuất bản</h6>
                    </div>
                    <div class="card-body">
                    <label for="status" class="form-label">Trạng thái</label>
                    <select id="status" class="form-select">
                        <option value="0">Bản nháp</option>
                        <option value="1">Đang duyệt</option>
                        <option value="2">Xuất bản</option>
                    </select>
                    </div>
                </div>
                </div>
            </div>
        </div>
        </form>
        </div>
      </main>
    </div>
  </div>
</body>

<script src="https://cdn.tiny.cloud/1/f6s0gxhkpepxkws8jawvfwtj0l9lv0xjgq1swbv4lgcy3au3/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
<script>
$(document).ready(function () {
    const year = new Date().getFullYear();
    var main = '';
    for(i=year; i>= 1900; i--){
        main += `<option value="${i}">${i}</option>`
    }
    document.getElementById("publishedYear").innerHTML = main
  const dropZone = document.getElementById("previewWrapper");
  const fileInput = document.getElementById("featuredImage");
  const btnSave = $("#btnSave");

  async function uploadImage(file) {
    if (!file || !file.type.startsWith("image/")) {
      toastr.warning("Vui lòng chọn tệp ảnh hợp lệ!");
      return;
    }

    btnSave.prop("disabled", true).text("Đang tải ảnh... ⏳");

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("http://localhost:8080/api/public/upload-file", {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        const imageUrl = await res.text();
        window.uploadedImageBanner = imageUrl;
        dropZone.innerHTML = `<img src="${imageUrl}" class="img-fluid rounded" />`;
        toastr.success("Tải ảnh bìa thành công!");
        $("#removeImage").prop("disabled", false);
      } else {
        toastr.error("Tải ảnh thất bại!");
      }
    } catch (err) {
      console.error("❌ Upload ảnh lỗi:", err);
      toastr.error("Không thể kết nối đến server upload!");
    } finally {
      btnSave.prop("disabled", false).text("Lưu");
    }
  }

  function handleFile(file) {
    if (file) {
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      uploadImage(file);
    }
  }

  // ========== DRAG & DROP ==========
  ["dragenter", "dragover", "dragleave", "drop"].forEach(evt =>
    dropZone.addEventListener(evt, e => e.preventDefault())
  );

  ["dragenter", "dragover"].forEach(evt =>
    dropZone.addEventListener(evt, () => dropZone.classList.add("border-primary"))
  );

  ["dragleave", "drop"].forEach(evt =>
    dropZone.addEventListener(evt, () => dropZone.classList.remove("border-primary"))
  );

  dropZone.addEventListener("drop", e => {
    const file = e.dataTransfer.files[0];
    handleFile(file);
  });

  // ========== CLICK TO OPEN FILE ==========
  dropZone.addEventListener("click", () => fileInput.click());

  // ========== INPUT CHANGE ==========
  fileInput.addEventListener("change", function () {
    const file = this.files[0];
    handleFile(file);
  });

  // ========== PASTE IMAGE ==========
  document.addEventListener("paste", e => {
    if (!e.clipboardData) return;
    const items = e.clipboardData.items;
    for (const item of items) {
      if (item.type.indexOf("image") !== -1) {
        const file = item.getAsFile();
        handleFile(file);
        break;
      }
    }
  });

  // ========== REMOVE IMAGE ==========
  $("#removeImage").on("click", function () {
    window.uploadedImageBanner = null;
    dropZone.innerHTML = `<span class="text-muted">Chưa có ảnh</span>`;
    $(this).prop("disabled", true);
  });
});

</script>

<script>
    var btnSave = $("#btnSave");
    window.documentPlant = null;
    $("#choose-doc").on("change", async function() {
        const file = this.files[0];
        if (!file) return;
        btnSave.prop("disabled", true).text("Đang tải tài liệu... ⏳");
        const formData = new FormData();
        formData.append("file", file);
        try {
            const res = await fetch("http://localhost:8080/api/public/upload-file", {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                const docUrl = await res.text();
                window.documentPlant = docUrl;
                toastr.success("Tải tài liệu thành công!");
                document.getElementById("noti-choosefile").innerText = 'Đã upload tài liệu'
            } else {
                const err = await res.text();
                toastr.error("Upload thất bại: " + err);
            }
        } catch (error) {
            console.error("❌ Upload lỗi:", error);
            toastr.error("Không thể kết nối tới server!");
        } 
        finally {
            btnSave.prop("disabled", false).text("Lưu");
        }
    });
</script>

<script>
  tinymce.init({
    selector: 'textarea#editor', // Chọn textarea có id là 'editor'
    // Tăng cường các plugin để hỗ trợ nhiều chức năng hơn
    plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak ' +
            'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking ' +
            'table emoticons template paste codesample help',
    // Định nghĩa các nút trên thanh công cụ. Chia thành nhiều dòng để dễ quản lý.
    toolbar: 'undo redo | blocks | ' + // Hoàn tác, làm lại, và định dạng khối (Heading 1, 2, Paragraph,...)
            'bold italic underline strikethrough | forecolor backcolor | ' + // Định dạng chữ: đậm, nghiêng, gạch chân, gạch ngang, màu chữ, màu nền
            'alignleft aligncenter alignright alignjustify | outdent indent | ' + // Căn lề, lùi dòng
            'numlist bullist | link image media table | ' + // Danh sách số, danh sách dấu chấm, chèn liên kết, ảnh, video, bảng
            'charmap emoticons | fullscreen code preview | help', // Ký tự đặc biệt, biểu tượng cảm xúc, chế độ toàn màn hình, xem trước, mã nguồn, trợ giúp
    height: 600, // Tăng chiều cao của trình soạn thảo
    menubar: 'file edit view insert format tools table help', // Hiện thêm menu bar ở trên cùng
    images_upload_handler: async function (blobInfo, success, failure) {
      const formData = new FormData();
      formData.append('file', blobInfo.blob(), blobInfo.filename());

      const res = await fetch('http://localhost:8080/api/public/upload-file', {
        method: 'POST',
        body: formData
      });
      if (res.status < 300) {
        var linkImage = await res.text();
        success(linkImage);
      }
    }
  });
</script>

  <script>
    function createSlug(name) {
      let slug = name.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/[\s_-]+/g, "-")
        .trim("-");
      document.getElementById("slug").value = slug;
    }
  </script>

</html>
