<!DOCTYPE html >
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
</head>
<body>
<th:block th:fragment="chatMain">
  <div class="chatbot-container">
    <div class="chatbox hidden" id="chatbox">
      <div class="chat-header">ğŸ¤– Há»— trá»£ AI </div>

      <div class="chat-messages" id="chat-messages">
      </div>

      <div class="chat-suggestions">
        <button id="toggle-suggestions-btn">
          ğŸ’¡ Gá»£i Ã½ cÃ¢u há»i
        </button>
        <div class="suggestion-list hidden" id="suggestion-list">
        </div>
      </div>

      <div class="chat-input-wrapper" id="chat-input-container">
        <div class="drop-zone hidden" id="drop-zone">
          Tháº£ áº£nh vÃ o Ä‘Ã¢y Ä‘á»ƒ gá»­i
        </div>

        <div class="image-preview-area hidden" id="image-preview-area">
          <img id="preview-image" src="" alt="áº¢nh Ä‘Ã£ chá»n" />
          <button id="remove-image-btn">âœ–</button>
        </div>
        <div class="chat-input">
          <input type="file" id="image-file-input" accept="image/*" class="hidden">

          <button id="attach-btn" class="input-action-btn" title="Gá»­i áº£nh">ğŸ“</button>

          <input
                  type="text"
                  id="chat-input-text"
                  placeholder="Nháº­p tin nháº¯n..."
          />

          <button id="send-message-btn" class="input-action-btn send-btn">Gá»­i</button>
        </div>

      </div>

    </div>

    <button class="chat-toggle" id="chat-toggle-btn">
      ğŸ’¬ Há»— trá»£ AI
    </button>
  </div>

  <script>
    // --- Khai bÃ¡o State vÃ  Data ---
    let isOpen = false;
    let messages = [];
    let showSuggestions = false;
    let selectedFile = null; // Biáº¿n lÆ°u trá»¯ file áº£nh Ä‘Ã£ chá»n/kÃ©o

    const suggestions = [
      "CÃ¢y SÃ¢m Ngá»c Linh cÃ³ cÃ´ng dá»¥ng gÃ¬?",
      "Liá»‡t kÃª cÃ¡c cÃ¢y dÆ°á»£c liá»‡u dÃ¹ng Ä‘á»ƒ chá»¯a bá»‡nh tiá»ƒu Ä‘Æ°á»ng.",
      "TÃ¬nh tráº¡ng cÃ¢y Quáº¿ táº¡i lÃ´ S1-A hiá»‡n táº¡i lÃ  gÃ¬?",
      "Thá»i Ä‘iá»ƒm thu hoáº¡ch tá»‘t nháº¥t cá»§a cÃ¢y Xáº¡ Äen lÃ  khi nÃ o?",
      "TÃ¬m quy trÃ¬nh nhÃ¢n giá»‘ng cho cÃ¢y Ba KÃ­ch.",
      "CÃ¢y nÃ o cÃ³ hoáº¡t cháº¥t tÆ°Æ¡ng tá»± cÃ¢y Báº¡ch Chá»‰?",
      "Nhiá»‡t Ä‘á»™ lÃ½ tÆ°á»Ÿng Ä‘á»ƒ trá»“ng cÃ¢y Lan Kim Tuyáº¿n lÃ  bao nhiÃªu?",
      "Kiá»ƒm tra sá»‘ lÆ°á»£ng tá»“n kho cá»§a dÆ°á»£c liá»‡u Äinh LÄƒng.",
    ];

    // --- Tham chiáº¿u DOM ---
    const chatbox = document.getElementById('chatbox');
    const chatToggleBtn = document.getElementById('chat-toggle-btn');
    const messagesContainer = document.getElementById('chat-messages');
    const inputText = document.getElementById('chat-input-text');
    const sendBtn = document.getElementById('send-message-btn');
    const toggleSuggestionsBtn = document.getElementById('toggle-suggestions-btn');
    const suggestionList = document.getElementById('suggestion-list');
    const attachBtn = document.getElementById('attach-btn');
    const imageFileInput = document.getElementById('image-file-input');
    const dropZone = document.getElementById('drop-zone');
    const imagePreviewArea = document.getElementById('image-preview-area'); // Má»›i
    const previewImage = document.getElementById('preview-image'); // Má»›i
    const removeImageBtn = document.getElementById('remove-image-btn'); // Má»›i


    // HÃ m mÃ´ phá»ng API postMethodPayload
    async function postMethodPayload(url, payload) {
      return new Promise(resolve => {
        setTimeout(() => {
          let reply = "ÄÃ£ nháº­n Ä‘Æ°á»£c yÃªu cáº§u cá»§a báº¡n. Vui lÃ²ng chá» pháº£n há»“i chi tiáº¿t.";
          if (payload.hasImage) {
            reply = "Cáº£m Æ¡n báº¡n Ä‘Ã£ gá»­i áº£nh! TÃ´i sáº½ xem xÃ©t vÃ  pháº£n há»“i sá»›m.";
          } else if (payload.message.includes('Menu') || payload.message.includes('mÃ³n gÃ¬')) {
            reply = "Menu hÃ´m nay cÃ³ CÃ¡ há»“i Ã¡p cháº£o vÃ  Salad Nga.";
          }
          resolve({
            json: () => Promise.resolve({ reply: reply })
          });
        }, 800);
      });
    }

    // HÃ m hiá»ƒn thá»‹/xÃ³a preview áº£nh
    function updateImagePreview() {
      if (selectedFile) {
        // Hiá»ƒn thá»‹ preview
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          imagePreviewArea.classList.remove('hidden');
        };
        reader.readAsDataURL(selectedFile);
        inputText.focus();
      } else {
        // XÃ³a preview
        imagePreviewArea.classList.add('hidden');
        previewImage.src = '';
        inputText.placeholder = "Nháº­p tin nháº¯n...";
      }
    }

    // Xá»­ lÃ½ khi nháº¥n nÃºt xÃ³a áº£nh
    function removeImage() {
      selectedFile = null;
      imageFileInput.value = null; // Äáº·t láº¡i input file
      updateImagePreview();
    }

    // HÃ m render láº¡i danh sÃ¡ch tin nháº¯n (ÄÃ£ cáº£i tiáº¿n)
    function renderMessages() {
      messagesContainer.innerHTML = '';
      messages.forEach((m, i) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${m.role}`;

        const contentSpan = document.createElement('span');
        contentSpan.innerHTML = `<b>${m.role === "user" ? "Báº¡n" : "Bot"}:</b> ${m.text || (m.role === 'user' && m.file ? ' [ÄÃ£ gá»­i áº£nh]' : '')}`;
        messageDiv.appendChild(contentSpan);

        if (m.role === 'user' && m.file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'message-image-preview';
            messageDiv.appendChild(img);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          };
          reader.readAsDataURL(m.file);
        }

        messagesContainer.appendChild(messageDiv);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // HÃ m render láº¡i danh sÃ¡ch gá»£i Ã½ (Giá»¯ nguyÃªn)
    function renderSuggestions() {
      suggestionList.innerHTML = '';
      suggestions.forEach((s, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'suggestion-item';
        itemDiv.textContent = s;
        itemDiv.onclick = () => handleSuggestionClick(s);
        suggestionList.appendChild(itemDiv);
      });
    }

    // HÃ m gá»­i tin nháº¯n (ÄÃ£ cáº£i tiáº¿n)
    async function sendMessage() {
      const message = inputText.value.trim();

      if (!message && !selectedFile) return;

      // 1. Cáº­p nháº­t tin nháº¯n ngÆ°á»i dÃ¹ng
      const userMessage = {
        role: "user",
        text: message,
        file: selectedFile
      };
      messages = [...messages, userMessage];

      // XÃ³a ná»™i dung input vÃ  file
      inputText.value = "";
      removeImage(); // XÃ³a preview vÃ  reset selectedFile

      showSuggestions = false;
      suggestionList.classList.add('hidden');
      renderMessages();

      // 2. Gá»i API
      const apiPayload = {
        message: userMessage.text,
        hasImage: !!userMessage.file
      };

      try {
        const res = await postMethodPayload("/api/chat", apiPayload);
        const data = await res.json();

        // 3. Cáº­p nháº­t tin nháº¯n bot
        messages = [...messages, { role: "bot", text: data.reply }];
        renderMessages();
      } catch (error) {
        messages = [...messages, { role: "bot", text: "Lá»—i káº¿t ná»‘i! KhÃ´ng thá»ƒ nháº­n pháº£n há»“i." }];
        renderMessages();
      }
    }

    // HÃ m xá»­ lÃ½ khi click vÃ o gá»£i Ã½
    function handleSuggestionClick(suggestion) {
      // LuÃ´n luÃ´n thÃªm gá»£i Ã½ vÃ o input text
      inputText.value += (inputText.value ? " " : "") + suggestion;
      inputText.focus();
    }

    // HÃ m báº­t/táº¯t chat vÃ  gá»£i Ã½ (Giá»¯ nguyÃªn)
    function toggleChat() {
      isOpen = !isOpen;
      if (isOpen) {
        chatbox.classList.remove('hidden');
        chatToggleBtn.innerHTML = 'âœ–';
        showSuggestions = false;
        suggestionList.classList.add('hidden');
      } else {
        chatbox.classList.add('hidden');
        chatToggleBtn.innerHTML = 'ğŸ’¬ Há»— trá»£ AI';
      }
    }
    function toggleSuggestions() {
      showSuggestions = !showSuggestions;
      suggestionList.classList.toggle('hidden', !showSuggestions);
    }

    // --- LOGIC Xá»¬ LÃ FILE VÃ€ KÃ‰O THáº¢ ---

    // Xá»­ lÃ½ khi cÃ³ file áº£nh Ä‘Æ°á»£c chá»n/kÃ©o
    function handleFile(file) {
      if (file.type.startsWith('image/')) {
        selectedFile = file;
        updateImagePreview();
      } else {
        alert("Chá»‰ há»— trá»£ file áº£nh.");
        selectedFile = null;
      }
    }

    // 1. Xá»­ lÃ½ nÃºt Ä‘Ã­nh kÃ¨m
    attachBtn.addEventListener('click', () => {
      imageFileInput.click();
    });

    // 2. Xá»­ lÃ½ khi chá»n file báº±ng input
    imageFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
        e.target.value = null;
      }
    });

    // 3. Xá»­ lÃ½ nÃºt xÃ³a áº£nh preview
    removeImageBtn.addEventListener('click', removeImage);

    // 4. Xá»­ lÃ½ kÃ©o vÃ  tháº£ (Drag and Drop)
    chatbox.addEventListener('dragenter', (e) => {
      e.preventDefault();
      if (e.dataTransfer.types && e.dataTransfer.types.includes('Files')) {
        dropZone.classList.remove('hidden');
      }
    });
    chatbox.addEventListener('dragleave', (e) => {
      if (!chatbox.contains(e.relatedTarget)) {
        dropZone.classList.add('hidden');
      }
    });
    chatbox.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.remove('hidden');
    });
    chatbox.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.add('hidden');

      if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
      }
    });


    // --- Thiáº¿t láº­p Event Listeners khi DOM Ä‘Ã£ táº£i xong ---
    document.addEventListener('DOMContentLoaded', () => {
      // Khá»Ÿi táº¡o tráº¡ng thÃ¡i ban Ä‘áº§u
      chatbox.classList.add('hidden');
      suggestionList.classList.add('hidden');
      imagePreviewArea.classList.add('hidden'); // áº¨n preview ban Ä‘áº§u
      renderSuggestions();

      // Gáº¯n sá»± kiá»‡n
      chatToggleBtn.addEventListener('click', toggleChat);
      sendBtn.addEventListener('click', sendMessage);
      toggleSuggestionsBtn.addEventListener('click', toggleSuggestions);

      inputText.addEventListener('keydown', (e) => {
        if (e.key === "Enter") {
          sendMessage();
          e.preventDefault();
        }
      });
    });
  </script>
</th:block>
</body>
</html>